# 1.Terraform 入門

## EC2 の起動

ファイルを作成

```main.tf
provider "aws" {
  profile = "terraform"
  region  = "ap-northeast-1"
}

resource "aws_instance" "hello-world" {
  ami           = "ami-07c2a88388bb80eb0"
  instance_type = "t2.micro"
  tags = {
    Name = "terraform-sandbox"
  }
}
```

`$ terraform apply`を実行すると**tfstate**というログのようなファイルが生成される

tfstate ファイルには、クラウド上の状態が保存されています。

`$ terraform apply`を実行すると、EC2 instance が再生成される場合と、再生成されない場合がある

# 2. Terraform 基本構文

## HCL2

### 概要

- HCL2（HashiCorp Configuration Language 2）は、Infrastructure as Code（IaC）ツールである Terraform の設定ファイルで使用される言語です。
- ブロックタイプについて
  - HCL2 では、ブロックタイプと呼ばれる構造が使用されます。
  - HCL2 では、異なるブロックタイプを使用することで、様々な要素を定義することができる。例えば、変数を定義するために variable ブロックタイプ、データソースを定義するために data ブロックタイプなどがあります。
  - 各ブロックタイプは、その要素に固有の属性と値を持ちます。
- ブロックタイプを使用することで、Terraform の設定ファイルを階層的な構造で表現し、リソースや設定の関係性を明確にすることができます。

| ブロックタイプ | 説明                                                                                                                                                    |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `provider`     | プロバイダを設定します。プロバイダは、Terraform がリソースを管理するために利用するサービスやプラットフォームを表します（例：aws、google、azurerm 等）。 |
| `resource`     | リソースを定義します。リソースは、Terraform が管理するインフラストラクチャの個々の部品を表します（例：EC2 インスタンス、S3 バケット等）。               |
| `data`         | 既存のリソースの詳細を読み込みます。データソースは、外部のリソースやサービスから読み取る情報を表します。                                                |
| `output`       | 出力値を定義します。出力値は、Terraform が管理するリソースの属性を出力し、他の設定やユーザーが使用できるようにします。                                  |
| `module`       | モジュールを呼び出します。モジュールは、Terraform 設定の一部を他の設定で再利用可能な形でパッケージ化します。                                            |
| `locals`       | ローカル値を定義します。ローカル値は、この設定内で繰り返し使用する複雑な値を一箇所で定義するための便利な方法です。                                      |
| `variable`     | 入力変数を定義します。入力変数は、設定値をパラメータとして渡すことができ、モジュールや設定の再利用性を高めます。                                        |

これらは一般的によく使用されるブロックタイプ

> **Note**
> 各ブロックタイプの詳細な情報や、その他のブロックタイプについては、下記を参照
> [Terraform の公式ドキュメンテーション](https://www.terraform.io/docs/language/index.html)

## 変数

| ブロックタイプ | 説明                                                                                                               |
| -------------- | ------------------------------------------------------------------------------------------------------------------ |
| `locals`       | ローカル値を定義します。ローカル値は、この設定内で繰り返し使用する複雑な値を一箇所で定義するための便利な方法です。 |
| `variable`     | 入力変数を定義します。入力変数は、設定値をパラメータとして渡すことができ、モジュールや設定の再利用性を高めます。   |

### variables と locals の使い分け

`variables`と`locals`は、Terraform の HCL2 言語で使用される 2 つの異なるブロックタイプです。それぞれの使い分けについて以下に説明します。

1. `locals`ブロック:
   - 目的: 設定ファイル内で再利用可能なローカル変数や関数を定義するために使用します。
   - 特徴:
     - 計算や変換ロジックを含む複雑な式を使用して値を定義できます。
     - モジュール内でのみ使用されるローカルな値や関数を定義するために使用します。
     - 設定ファイルの可読性や保守性を向上させるために使用します。
   - 例: CIDR ブロックの生成、リソース名の結合、数値の計算など。
2. `variables`ブロック:

   - 目的: 外部から提供されるパラメータ（変数）を設定ファイル内で定義するために使用します。
   - 特徴:
     - ユーザーからの入力や.tfvars ファイルなどの方法で変数の値を指定できます。
     - デフォルト値を指定することもできます。
     - 複数のモジュールやリソース間で共有する必要があるパラメータに使用します。
   - 例: AWS のリージョン、サブネット CIDR、リソース名など。

基本的な使い分けのガイドラインは次の通りです。

- `locals`は、設定ファイル内でのみ使用されるローカルな変数や関数を定義するために使用します。計算や変換ロジックを含む複雑な式を使用して値を生成する場合や、可読性や保守性のためにローカルな名前を定義する場合に使用します。

- `variables`は、外部からの入力や再利用が必要なパラメータを定義するために使用します。通常、ユーザーが変数の値を指定し、複数のモジュールやリソース間で共有する必要がある場合に使用します。

### locals

※ AWS のリージョンに基づいて VPC の CIDR ブロックを定義する場合の例

```sample.tf
locals {
  region           = "us-west-2"
  vpc_cidr_block   = local.generate_vpc_cidr_block(local.region)
  subnet_cidr_base = "10.0"
}

resource "aws_vpc" "example" {
  cidr_block = local.vpc_cidr_block

  # 他の設定...
}

locals {
  function generate_vpc_cidr_block(region) {
    return "${local.subnet_cidr_base}.0.0/16"
  }
}

```

### variable

```sample.tf
variable "aws_region" {
  description = "AWSリージョン"
  type        = string
  default     = "us-west-2"
}

variable "resource_group_name" {
  description = "リソースグループ名"
  type        = string
}

resource "aws_resourcegroups_group" "example" {
  name = var.resource_group_name

  # 他の設定...
}
```

## データ型

以下は、HCL2 で扱える一般的なデータ型の種類、型名、および説明です。

| 種類           | 型名         | 説明                                                                                                                                                                 |
| -------------- | ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| プリミティブ型 | `bool`       | 真偽値 (`true`または`false`) を表す型。                                                                                                                              |
|                | `number`     | 数値（整数または浮動小数点数）を表す型。                                                                                                                             |
|                | `string`     | 文字列を表す型。                                                                                                                                                     |
|                | `list`       | 要素の順序付きリストを表す型。個々の要素は異なるデータ型を持つことができます。                                                                                       |
|                | `map`        | キーと値のペアの集合を表す型。キーと値は異なるデータ型を持つことができます。                                                                                         |
|                | `tuple`      | 複数の異なるデータ型の要素を順序付きで保持する型。各要素はインデックスを持ちます。                                                                                   |
|                | `object`     | キーと値のペアからなるオブジェクトを表す型。キーは文字列で、値は異なるデータ型を持つことができます。                                                                 |
| コレクション型 | `set`        | 要素の重複を許さない順序なし集合を表す型。個々の要素は異なるデータ型を持つことができます。                                                                           |
|                | `array`      | 要素の順序付き配列を表す型。個々の要素は同じデータ型を持つ必要があります。                                                                                           |
|                | `map`        | キーと値のペアの集合を表す型。キーと値は同じデータ型を持つ必要があります。                                                                                           |
|                | `object`     | キーと値のペアからなるオブジェクトを表す型。キーは文字列で、値は同じデータ型を持つ必要があります。                                                                   |
|                | `for_each`   | キーと値のペアからなるオブジェクトを表す型。キーは文字列で、値は同じデータ型を持つ必要があります。リソースやモジュールの複数のインスタンスを作成する際に使用します。 |
|                | `depends_on` | リソース間の依存関係を表す型。                                                                                                                                       |
|                | `module`     | モジュールへの参照を表す型。                                                                                                                                         |
|                | `resource`   | 　リソースへの参照を表す型。                                                                                                                                         |

## 外部から変数を与える

HCL2 における外部から変数値を与える方法は下記 3 種類です。
| 種類 | 説明 |
| ------------ | ----------------------------------------------------------------------------------------------------- |
| 環境変数 | 環境変数を使用して変数値を指定します。Terraform は`TF_VAR_`接頭辞を持つ環境変数を自動的に認識します。 |
| 変数ファイル | `.tfvars`または`.tfvars.json`という拡張子を持つファイルに変数値を記述します。 |
| コマンド引数 | Terraform コマンドの実行時に`-var`フラグを使用して変数値を指定します。 |

※ 優先度としては、コマンド引数 > 変数ファイル > 環境変数　の順になっています。

これらの方法は、Terraform の実行時に変数値を指定するための主要な手段です。以下にそれぞれの方法の詳細な説明を示します。

- 環境変数: 環境変数を使用して変数値を指定します。Terraform は`TF_VAR_`接頭辞を持つ環境変数を自動的に認識します。たとえば、`TF_VAR_variable_name`という形式の環境変数を使用して変数値を設定します。

- 変数ファイル: `.tfvars`または`.tfvars.json`という拡張子を持つファイルに変数値を記述します。変数ファイルを使用する場合、Terraform 実行時に`-var-file`フラグを使用してファイルを指定します。

- コマンド引数: Terraform コマンドの実行時に`-var`フラグを使用して変数値を指定します。たとえば、`-var="variable_name=value"`という形式で変数値を指定します。

### 使い分けについて

以下は、外部から変数値を与える方法の 3 つ（環境変数、変数ファイル、コマンド引数）の使い分けを、種類と使い分けの説明をテーブル形式で Markdown で表示したものです。

| 種類         | 使い分けの説明                                                                                                                                                                 |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 環境変数     | - 機密情報やセンシティブなデータを隠すために使用します。<br>- 変数値がプロジェクト全体で一貫している場合に適しています。<br>- 継続的な実行環境での一元管理が可能です。         |
| 変数ファイル | - 特定の実行環境やプロジェクトごとに異なる変数値を管理するために使用します。<br>- バージョン管理された変数ファイルを使用してバージョン管理の一貫性を確保できます。             |
| コマンド引数 | - 実行ごとに変数値を指定する必要がある場合に使用します。<br>- 手動で実行する場合や一時的な変更が必要な場合に便利です。<br>- コマンドラインのオプションとして直接指定できます。 |

これらの方法は、外部からの変数値の提供方法に選択肢を与えます。それぞれの使い分けは、プロジェクトの要件やセキュリティポリシーに基づいて決定する必要があります。一般的なガイドラインとしては、環境変数は機密性が高く、一貫性が必要な変数に適しています。変数ファイルはプロジェクトごとや実行環境ごとに異なる変数値を管理するために使用されます。コマンド引数は実行ごとに一時的な変更が必要な場合に便利です。

プロジェクトやチームのニーズに合わせて、適切な方法を選択して変数値を提供してください。セキュリティに配慮し、機密情報を適切に保護することも重要です。

## Terraform その他ブロック概要

1. `terraform`ブロック:

   - 役割: Terraform のバージョン制約やバックエンドの設定など、Terraform の全体的な設定を行うために使用されます。
   - 例:
     ```hcl
     terraform {
       required_version = ">= 0.12"
       backend "s3" {
         bucket = "example-bucket"
         key    = "terraform.tfstate"
         region = "us-west-2"
       }
     }
     ```

2. リソースブロック:

   - 役割: インフラストラクチャのリソース（AWS EC2 インスタンス、Azure 仮想マシンなど）を定義するために使用されます。
   - 例:
     ```hcl
     resource "aws_instance" "example" {
       ami           = "ami-0c94855ba95c71c99"
       instance_type = "t2.micro"
       subnet_id     = "subnet-0123456789abcdef0"
     }
     ```

3. データソースブロック:

   - 役割: 外部の情報（AWS S3 バケット、Azure 仮想ネットワークなど）を参照するために使用されます。Terraform がデータソースを使用して情報を取得し、リソースの作成や構成に利用できます。
   - 例:
     ```hcl
     data "aws_s3_bucket" "example" {
       bucket = "example-bucket"
     }
     ```

4. プロバイダブロック:

   - 役割: クラウドプロバイダ（AWS、Azure、Google Cloud など）との接続設定を行います。各プロバイダは独自のブロックタイプを持ち、リソースやデータソースを提供します。
   - 例:
     ```hcl
     provider "aws" {
       region = "us-west-2"
     }
     ```

5. モジュールブロック:

   - 役割: 再利用可能なインフラストラクチャのテンプレート（モジュール）を定義します。モジュールは、パラメータ化された設定を受け取り、一連のリソースやデータソースを作成するために使用されます。
   - 例:
     ```hcl
     module "example" {
       source = "./modules/example"
       variable1 = "value1"
       variable2 = "value2"
     ```

6. 変数ブロック:
   - 役割: Terraform の設定ファイルで使用する変数を定義します。変数は、設定の柔軟性や再利用性を向上させるために使用されます。
   - 例:
     ```hcl
     variable "region" {
       type    = string
       default = "us-west-2"
     }
     ```
7. アウトプットブロック

   - 役割:

     - `output`ブロックは、Terraform の実行結果をユーザーに表示するために使用されます。
     - 計算結果やリソースの属性値など、設定ファイル内の値を表示することができます。
     - `output`ブロックで定義された値は、Terraform の実行後に表示されるため、デバッグや監視、他のツールとの統合に役立ちます。

   - 例:
     ```hcl
     output "example_output" {
       value = aws_instance.example.private_ip
     }
     ```

## リソース参照

## 組み込み関数

組み込み関数に関して説明します。

1. 組み込み関数とは何か？
   組み込み関数は、Terraform の HCL2 言語で使用される事前定義された関数です。これらの関数は Terraform の設定ファイル内で使用され、変数の変換、文字列の操作、数値の演算、リソースの参照など、様々な目的で利用されます。

   例:

   - `concat()`関数: 複数の文字列を結合します。

     ```hcl
     locals {
       name = concat("Hello", " ", "World")  // "Hello World"
     }
     ```

   - `length()`関数: リストや文字列の長さを取得します。
     ```hcl
     locals {
       list_length = length([1, 2, 3])  // 3
       str_length = length("Hello")     // 5
     }
     ```

2. 組み込み関数の探し方（公式ドキュメント）:
   組み込み関数のドキュメントは Terraform の公式ドキュメントで提供されています。以下の手順に従って組み込み関数を探すことができます:

   - [Terraform 公式ドキュメント](https://www.terraform.io/docs/language/functions/index.html)にアクセスします。
     組み込み関数のリストと詳細な説明が提供されているため、必要な関数を見つけることができます。

3. 組み込み関数の試し方（Terraform Console）:
   組み込み関数を試すためには、Terraform Console を使用することができます。Terraform Console は、Terraform のコマンドラインインターフェースの一部であり、HCL2 の評価や組み込み関数の実行に使用されます。

   - コマンドラインで`terraform console`を実行します。
   - Terraform Console プロンプトが表示されます。ここで、組み込み関数を試すことができます。
   - 例えば、以下のように関数を使用して評価できます。
     ```hcl
     > concat("Hello", " ", "World")
     "Hello World"
     ```

   Terraform Console を使用することで、組み込み関数の動作を直接試すことができます。関数の使用方法や結果を確認する際に便利です。

## ファイル分割

```

```
